<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="format-detection" content="telephone=no" />
  <title>Buzzer Neon Pro - GI√ÅO VI√äN & N·ªòI DUNG C√ÇU H·ªéI</title>

  <script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-database.js"></script>
  
  <script>
      window.MathJax = {
          tex: {
              inlineMath: [['$', '$'], ['\\(', '\\)']] 
          },
          startup: {
              typeset: false 
          }
      };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    /* ===== CSS T·ªïng quan & n·ªÅn neon ƒë·ªông (t·ª´ Buzzer) ===== */
    :root{
      --bg1: #121216;
      --bg2: #181824;
      --accent1: #00d4ff;
      --accent2: #9b6bff;
      --glass: rgba(255,255,255,0.04);
    }
    html,body{
      height:100%;
      margin:0;
      padding:0;
      font-family: Inter, "Segoe UI", Roboto, sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      background: linear-gradient(180deg,var(--bg2),var(--bg1));
      overflow:auto; 
      touch-action: auto; 
    }
    .neon-bg {
      position:fixed; inset:0; z-index:0; filter: blur(60px); opacity:0.45;
      background: radial-gradient(30% 30% at 20% 30%, rgba(0,212,255,0.14), transparent 12%),
        radial-gradient(25% 25% at 80% 70%, rgba(155,107,255,0.12), transparent 15%);
      animation: bgFloat 18s linear infinite; pointer-events:none;
    }
    @keyframes bgFloat {
      0% { transform: translate(0,0) scale(1); }
      50% { transform: translate(-4%, 3%) scale(1.03); }
      100% { transform: translate(0,0) scale(1); }
    }
    .app { position:relative; z-index:2; width:100%; min-height:100vh; display:flex; flex-direction: column; align-items:flex-start; /* <--- ƒê·ªîI TH√ÄNH flex-start */ justify-content:flex-start; padding:20px; box-sizing:border-box; }
    .card { width:100%; max-width:1200px; border-radius:16px; padding:18px; background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); box-shadow: 0 8px 40px rgba(0,0,0,0.6); color:#e8eef6; position:relative; overflow:hidden; margin: 0 auto; /* <--- TH√äM D√íNG N√ÄY ƒê·ªÇ CƒÇN GI·ªÆA KH·ªêI CH√çNH */ }
    h1 { margin:6px 0 0 0; font-size:1.2rem; letter-spacing:0.6px; color:#dff7ff;}
    .sub { color: #bcdff0; font-size:0.9rem; opacity:0.9; }

    /* Control & Status */
    .teacher-controls { display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-start; /* <--- ƒê√É ƒê·ªîI TH√ÄNH CƒÇN TR√ÅI */ margin-top:0px; }
    .teacher-controls button { padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:600; background:linear-gradient(180deg,#3b82f6,#2256d6); color:#fff; box-shadow:0 8px 24px rgba(35,82,150,0.28); }
    .teacher-controls button:disabled { opacity: 0.6; cursor: not-allowed; }
    #countdown-display { font-size:1.4rem; font-weight:800; color:var(--accent1); text-shadow:0 6px 18px rgba(0,212,255,0.12); }
    #teams-status { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:12px; width:100%; }
    .team-box { min-width:110px; padding:10px; border-radius:10px; text-align:center; color:#041018; font-weight:700; box-shadow: 0 4px 14px rgba(0,0,0,0.5); background:linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.75)); white-space: pre-wrap; }

    /* ===== Layout N·ªôi dung & B·∫£ng ƒêi·ªÉm (t·ª´ Game TƒÉng T·ªëc) ===== */
    .main-content-layout { display: flex; gap: 20px; width: 100%; flex-wrap: wrap; margin-top: 20px; }
    .game-container { flex: 3; min-width: 500px; background-color: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); color: #333; }
    #score-board-container { flex: 1; min-width: 250px; padding: 20px; border-radius: 10px; background-color: #3c414d; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); }
    
    /* B·∫¢NG ƒêI·ªÇM */
    .team-score-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; padding: 10px; border-radius: 8px; font-weight: bold; color: white; transition: transform 0.2s; }
    .team-name { font-size: 1.1em; }
    .team-score { font-size: 1.8em; }
    .score-control button { background: rgba(255, 255, 255, 0.2); border: none; color: white; padding: 5px 10px; margin-left: 5px; border-radius: 5px; cursor: pointer; font-size: 1em; font-weight: 900; line-height: 1; transition: background 0.2s; }
    /* M√ÄU ƒê·ªòI */
    .team-red { background-color: #e74c3c; } .team-blue { background-color: #3498db; } .team-green { background-color: #2ecc71; }
    .team-yellow { background-color: #f1c40f; color: #333; } .team-purple { background-color: #9b59b6; }
    
    /* N·ªòI DUNG C√ÇU H·ªéI */
    .question-number { font-size: 1.2em; color: #2A52BE; margin-bottom: 10px; font-weight: bold; }
    .question-text { font-size: 1.8em; margin-bottom: 20px; font-weight: 500; }
    .options-container { display: flex; flex-direction: column; gap: 8px; }
    .option { padding: 12px; border: 1px solid #ccc; border-radius: 8px; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; font-size: 1.5em; }
    .option:hover:not(.disabled) { background-color: #e9e9e9; border-color: #aaa; }
    .option.correct { background-color: #d4edda; border-color: #c3e6cb; }
    .option.incorrect { background-color: #f8d7da; border-color: #f5c6fb; }
    .option.disabled { cursor: default; opacity: 0.6; }
    .result-message { margin-top: 15px; font-size: 1.5em; font-weight: bold; }
    .button-action { padding: 15px 30px; font-size: 1.5em; cursor: pointer; background-color: #5cb85c; color: white; border: none; border-radius: 8px; transition: background-color 0.2s; }
    .button-action:hover { background-color: #4cae4c; }
    #buzzer-message { font-size: 1.5em; font-weight: bold; color: #e74c3c; margin-bottom: 10px; }
    
  </style>
</head>
<body>

  <div class="neon-bg" aria-hidden="true"></div>

  <div class="app">
    <div class="card" role="application">
  
      <div id="teacher-screen" style="width:100%; margin-top:12px;">
        
        <div style="display:flex;flex-direction:column;align-items:flex-start;width:100%; border: 1px solid var(--accent2); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
    
    <div class="control-bar" style="display:flex; gap: 15px; flex-wrap: wrap; align-items: center; width: 100%;">
        
        <h2 style="color: var(--accent2); margin-top: 0; margin-bottom: 0; font-size: 1.1rem; flex-shrink: 0;"> </h2>
        
        <div id="result-display" style="min-height:28px;color:gold;font-weight:800;margin-bottom:0; flex-shrink: 0; font-size: 0.9rem;">ƒêang ch·ªù k·∫øt n·ªëi...</div>
        
        <div id="countdown-display" style="margin-top:0; font-size:1.1rem; font-weight:800; color:var(--accent1); text-shadow:0 6px 18px rgba(0,212,255,0.12); flex-shrink: 0;">CH·ªú L·ªÜNH</div> 
        
        <div class="teacher-controls" style="margin-top:0; margin-left: auto;"> 
            <button id="start-button">B·∫Øt ƒë·∫ßu l∆∞·ª£t (ƒê·∫øm ng∆∞·ª£c)</button>
            <button id="end-round-button" style="display:none;background:#00c2a8;">K·∫øt th√∫c l∆∞·ª£t / Kh√≥a chu√¥ng</button>
            <button id="master-reset-button" style="background:#ff6b6b;">Reset t·ªïng (X√≥a data HS)</button>
        </div>
    </div>
    
    <div id="teams-status" style="margin-top: 10px;"></div>
</div>
        
        <div class="main-content-layout">
            
            <div class="game-container">
                <div id="buzzer-message">S·∫µn s√†ng b·∫•m chu√¥ng...</div>
                
                <button id="startButton" class="button-action" style="margin-bottom: 20px; display: none;">V√íNG 1 (B·∫Øt ƒê·∫ßu C√¢u H·ªèi)</button>

                <div id="game-content" style="display: block;">
                    <div class="question-box">
                        <div class="question-number">C√¢u h·ªèi <span id="current-q-number">1</span>/25</div>
                        <div class="question-text" id="question-text"></div>
                    </div>

                    <div class="options-container" id="options-container">
                        <div class="option" data-answer="A">A. <span id="option-a"></span></div>
                        <div class="option" data-answer="B">B. <span id="option-b"></span></div>
                        <div class="option" data-answer="C">C. <span id="option-c"></span></div>
                        <div class="option" data-answer="D">D. <span id="option-d"></span></div>
                    </div>

                    <div class="result-message" id="result-message"></div>
                    <button id="nextQuestionButton" class="button-action" style="display: none; margin-top: 20px; background-color: #3498db;">C√¢u h·ªèi ti·∫øp theo >></button>
                </div>

                <div id="final-results" style="display: none; text-align: center; margin-top: 30px; color: #333;">
                    <h2>K·∫æT TH√öC TR√í CH∆†I!</h2>
                    <p style="font-size: 1.5em;">ƒê√£ ho√†n th√†nh c√°c c√¢u h·ªèi. <br> T·ªïng k·∫øt ƒëi·ªÉm ·ªü b·∫£ng b√™n c·∫°nh.</p>
                    <button class="button-action" onclick="location.reload()">Ch∆°i L·∫°i</button>
                </div>
            </div>

            <div id="score-board-container">
                <h2 style="text-align: center; color: #f1c40f; margin-top: 0;">B·∫£ng ƒêi·ªÉm ƒê·ªôi</h2>
                <div id="score-board">
                    </div>
            </div>
        </div>

      </div>
      </div>
  </div>

  <script src="script.js"></script>
  <script>
    // **********************************************
    // D·ªÆ LI·ªÜU & BI·∫æN TR·∫†NG TH√ÅI
    // **********************************************
    
    // D·ªØ li·ªáu c√¢u h·ªèi (25 c√¢u)
    const questions = [
        // 15 C√ÇU C∆† B·∫¢N (A)
        { q: 'Cho CSC ($u_n$) c√≥ $u_1 = 5$, $d = -3$. S·ªë h·∫°ng th·ª© t∆∞ $u_4$ l√†:', options: ['4', '-4', '-12', '2'], correct: 'B' },
        { q: 'Cho CSC ($u_n$) c√≥ $u_5 = 18$, $u_{10} = 38$. C√¥ng sai $d$ l√†:', options: ['2', '3', '4', '5'], correct: 'C' },
        { q: 'Cho CSC ($u_n$) c√≥ $u_1 = 2$, $d = 3$. T·ªïng $S_{10}$ l√†:', options: ['155', '310', '150', '95'], correct: 'A' },
        { q: 'CSC ($u_n$) ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a b·ªüi h·ªá th·ª©c truy h·ªìi n√†o sau ƒë√¢y:', options: ['$u_n = u_{n-1} + n$', '$u_n = u_{n-1} \\cdot 2$', '$u_n = u_{n-1} + 5$', '$u_n = u_1 + (n-1)d$'], correct: 'C' },
        { q: 'Cho CSC ($u_n$) c√≥ $u_1 = 5$, $d = 2$. ƒê·ªÉ t·ªïng $S_n = 480$, s·ªë l∆∞·ª£ng s·ªë h·∫°ng $n$ l√†:', options: ['15', '18', '20', '24'], correct: 'C' },
        { q: 'Cho CSN ($u_n$) c√≥ $u_1 = -4$, $q = 3$. S·ªë h·∫°ng th·ª© nƒÉm $u_5$ l√†:', options: ['-108', '-324', '324', '-400'], correct: 'B' },
        { q: 'C√¥ng th·ª©c t√≠nh t·ªïng $n$ s·ªë h·∫°ng ƒë·∫ßu ti√™n c·ªßa CSC ($u_n$) l√†:', options: ['$S_n = \\frac{n(u_1 + u_n)}{2}$', '$S_n = u_1 \\frac{1 - q^n}{1 - q}$', '$S_n = u_1 + (n-1)d$', '$S_n = n(u_1 + u_n)$'], correct: 'A' },
        { q: 'Cho CSN ($u_n$) c√≥ $u_4 = 54$, $q = 3$. S·ªë h·∫°ng ƒë·∫ßu ti√™n $u_1$ l√†:', options: ['2', '6', '18', '162'], correct: 'A' },
        { q: 'S·ªë h·∫°ng t·ªïng qu√°t $u_n$ c·ªßa m·ªôt CSN ($n \\ge 1$) ƒë∆∞·ª£c x√°c ƒë·ªãnh b·ªüi c√¥ng th·ª©c n√†o:', options: ['$u_n = u_1 + (n-1)q$', '$u_n = u_1 \\cdot q^{n-1}$', '$u_n = u_1 \\cdot q^n$', '$u_n = u_1 \\cdot q + u_{n-1}$'], correct: 'B' },
        { q: 'Cho CSN ($u_n$) c√≥ $u_1 = 2$, $q = -3$. T√≠nh t·ªïng $S_4$:', options: ['-40', '122', '40', '-160'], correct: 'A' },
        { q: 'C√¥ng th·ª©c t√≠nh t·ªïng $n$ s·ªë h·∫°ng ƒë·∫ßu ti√™n c·ªßa CSC theo $u_1$ v√† $d$ l√†:', options: ['$S_n = \\frac{n}{2}[2u_1 + (n-1)d]$', '$S_n = n \\cdot u_n$', '$S_n = \\frac{n}{2}[u_1 + d]$', '$S_n = u_1 \\cdot q^{n-1}$'], correct: 'A' },
        { q: 'C√¥ng th·ª©c t√≠nh t·ªïng $n$ s·ªë h·∫°ng ƒë·∫ßu ti√™n c·ªßa CSN ($q \\ne 1$) l√†:', options: ['$S_n = u_1 (1 - q^n)$', '$S_n = u_1 + u_n$', '$S_n = u_1 \\frac{1 - q^n}{1 - q}$', '$S_n = \\frac{n}{2}[2u_1 + (n-1)q]$'], correct: 'C' },
        { q: 'Cho CSC ($u_n$) c√≥ $u_1 = 10$, $S_{10} = 205$. H√£y t√¨m $u_{10}$:', options: ['31', '21', '41', '35'], correct: 'A' },
        { q: 'Cho CSC ($u_n$) c√≥ $u_1 = -5$, $d = 4$. C√¥ng th·ª©c t√≠nh t·ªïng $S_n$ l√†:', options: ['$S_n = n(2n - 7)$', '$S_n = n(4n - 9)$', '$S_n = 2n^2 - 5n$', '$S_n = n(4n - 10)$'], correct: 'A' },
        { q: 'CSN ($u_n$) ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a b·ªüi h·ªá th·ª©c truy h·ªìi n√†o sau ƒë√¢y:', options: ['$u_n = u_{n-1} + 3$', '$u_n = u_{n-1} + u_{n-2}$', '$u_n = 2u_{n-1}$', '$u_n = u_1 + 2^{n-1}$'], correct: 'C' },

        // 10 C√ÇU NH·∫¨N DI·ªÜN V√Ä VI·∫æT S·ªê H·∫†NG (B)
        { q: 'D√£y s·ªë n√†o sau ƒë√¢y l√† **c·∫•p s·ªë c·ªông**?', options: ['1; 2; 4; 8', '1; 3; 5; 7', '1; -1; 1; -1', '1; 4; 9; 16'], correct: 'B' },
        { q: 'D√£y s·ªë n√†o sau ƒë√¢y l√† **c·∫•p s·ªë nh√¢n**?', options: ['2; 5; 8; 11', '10; 5; 2.5; 1.25', '1; 1; 2; 3; 5', '1; 3; 5; 7'], correct: 'B' },
        { q: 'Cho CSC ($u_n$) c√≥ $u_1 = 10$, $d = -2$. Ba s·ªë h·∫°ng ƒë·∫ßu ti√™n l√†:', options: ['10; 12; 14', '10; 8; 6', '10; -20; 40', '10; 5; 0'], correct: 'B' },
        { q: 'Cho CSN ($u_n$) c√≥ $u_1 = 16$, $q = 0.5$. Ba s·ªë h·∫°ng ƒë·∫ßu ti√™n l√†:', options: ['16; 8; 4', '16; 16.5; 17', '16; 32; 64', '16; 4; 1'], correct: 'A' },
        { q: 'D√£y s·ªë ($u_n$) v·ªõi $u_n = 3n + 1$. S·ªë h·∫°ng $u_3$ l√†:', options: ['7', '10', '4', '13'], correct: 'B' },
        { q: 'D√£y s·ªë ($u_n$) v·ªõi $u_n = 2^{n+1}$. S·ªë h·∫°ng $u_3$ l√†:', options: ['8', '16', '32', '10'], correct: 'B' },
        { q: 'D√£y s·ªë 5; 5; 5; 5 l√†:', options: ['Ch·ªâ l√† c·∫•p s·ªë c·ªông', 'Ch·ªâ l√† c·∫•p s·ªë nh√¢n', 'V·ª´a l√† CSC, v·ª´a l√† CSN', 'Kh√¥ng ph·∫£i CSC, kh√¥ng ph·∫£i CSN'], correct: 'C' },
        { q: 'Cho CSC ($u_n$) c√≥ $u_1 = 5$. Bi·∫øt $u_3 = 11$. C√¥ng sai $d$ l√†:', options: ['3', '6', '5.5', '1'], correct: 'A' },
        { q: 'Cho CSN ($u_n$) c√≥ $u_1 = 2$. Bi·∫øt $u_3 = 18$ ($q > 0$). C√¥ng b·ªôi $q$ l√†:', options: ['9', '4', '3', '6'], correct: 'C' },
        { q: 'D√£y s·ªë n√†o **kh√¥ng ph·∫£i** CSC c≈©ng **kh√¥ng ph·∫£i** CSN?', options: ['2; 4; 6; 8', '2; 6; 18; 54', '1; 4; 2; 5', '10; 10; 10; 10'], correct: 'C' }
    ];

    let currentQuestionIndex = 0;
    let currentAnsweringTeamColor = null; // M√†u c·ªßa ƒë·ªôi b·∫•m chu√¥ng (red, blue...)
    
    // D·ªØ li·ªáu v√† c·∫•u h√¨nh cho 5 ƒë·ªôi
    const teams = [
        { id: 'red', name: 'ƒê·ªôi ƒê·ªè', colorClass: 'team-red', score: 0 },
        { id: 'blue', name: 'ƒê·ªôi Xanh D∆∞∆°ng', colorClass: 'team-blue', score: 0 },
        { id: 'green', name: 'ƒê·ªôi Xanh L√°', colorClass: 'team-green', score: 0 },
        { id: 'yellow', name: 'ƒê·ªôi V√†ng', colorClass: 'team-yellow', score: 0 },
        { id: 'purple', name: 'ƒê·ªôi T√≠m', colorClass: 'team-purple', score: 0 },
    ];
    
    const TEAM_COLORS_DISPLAY = {
        red: { name: 'ƒê·ªôi ƒê·ªè', code: '#ff6b6b' },
        blue: { name: 'ƒê·ªôi Xanh D∆∞∆°ng', code: '#3498db' },
        green: { name: 'ƒê·ªôi Xanh L√°', code: '#2ecc71' },
        yellow: { name: 'ƒê·ªôi V√†ng', code: '#f1c40f' },
        purple: { name: 'ƒê·ªôi T√≠m', code: '#9b59b6' }
    };

    // DOM Elements
    const questionTextEl = document.getElementById('question-text');
    const qNumberEl = document.getElementById('current-q-number');
    const optionsContainerEl = document.getElementById('options-container');
    const resultMessageEl = document.getElementById('result-message');
    const finalResultsEl = document.getElementById('final-results');
    const optionElements = optionsContainerEl.querySelectorAll('.option');
    const scoreBoardContainerEl = document.getElementById('score-board-container');
    const nextQuestionButton = document.getElementById('nextQuestionButton');
    const buzzerMessageEl = document.getElementById('buzzer-message');


    // **********************************************
    // 1. KH·ªûI T·∫†O V√Ä B·∫¢NG ƒêI·ªÇM
    // **********************************************

    window.onload = function() {
        showScreen('teacher');
        // G·ªçi h√†m kh·ªüi t·∫°o Firebase t·ª´ script.js (ƒë√£ c√≥)
        setupTeacher(); 
        
        renderScoreBoard();
        loadQuestion(); // T·∫£i c√¢u h·ªèi ƒë·∫ßu ti√™n
        nextQuestionButton.addEventListener('click', () => {
            resetAndNextQuestion();
        });
    };

// GV.html (TH√äM H√ÄM M·ªöI CH·ªà RESET CHU√îNG)
function resetBuzzerOnly() {
    // 1. Reset tr·∫°ng th√°i b·∫•m chu√¥ng tr√™n Firebase (ƒë·∫∑t l·∫°i state c·ªßa players v·ªÅ 'waiting')
    window.resetBuzzerSession(); 
    
    // 2. Thi·∫øt l·∫≠p tr·∫°ng th√°i game cho ph√©p b·∫•m chu√¥ng ngay l·∫≠p t·ª©c
    gameRef.child('status').set('press_allowed');
    
    // C·∫≠p nh·∫≠t giao di·ªán Gi√°o vi√™n (n·∫øu c·∫ßn)
    const startButton = document.getElementById('start-button');
    const endRoundButton = document.getElementById('end-round-button');
    if (startButton && endRoundButton) {
        startButton.style.display = 'none';
        endRoundButton.style.display = 'inline-block';
        document.getElementById('countdown-display').textContent = 'CH·ªú B·∫§M';
    }
}

    function showScreen(mode){
        document.getElementById('teacher-screen').style.display = (mode==='teacher') ? 'block' : 'none';
    }

    // C·∫≠p nh·∫≠t ƒëi·ªÉm v√† l∆∞u v√†o Local Storage (ƒë·ªÉ gi·ªØ ƒëi·ªÉm sau khi F5)
    function updateTeamScore(teamId, delta) {
        const team = teams.find(t => t.id === teamId);
        if (team) {
            team.score += delta;
            document.getElementById(`score-${teamId}`).textContent = team.score;
            // C·∫≠p nh·∫≠t Local Storage
            localStorage.setItem('teamScores', JSON.stringify(teams.map(t => ({ id: t.id, score: t.score }))));
        }
    }

    function renderScoreBoard() {
        const savedScores = JSON.parse(localStorage.getItem('teamScores'));
        if (savedScores) {
            savedScores.forEach(saved => {
                const team = teams.find(t => t.id === saved.id);
                if (team) team.score = saved.score;
            });
        }
        
        const board = document.getElementById('score-board');
        board.innerHTML = ''; 
        
        teams.forEach(team => {
            const item = document.createElement('div');
            item.className = 'team-score-item ' + team.colorClass;
            item.innerHTML = `
                <div class="team-info">
                    <div class="team-name">${team.name}</div>
                    <div class="team-score" id="score-${team.id}">${team.score}</div>
                </div>
                <div class="score-control">
                    <button onclick="updateTeamScore('${team.id}', 10)">+10</button>
                    <button onclick="updateTeamScore('${team.id}', -5)">-5</button>
                </div>
            `;
            board.appendChild(item);
        });
        scoreBoardContainerEl.style.display = 'block';
    }
    
    // ƒê∆∞a h√†m updateTeamScore ra global scope ƒë·ªÉ c√°c n√∫t HTML c√≥ th·ªÉ g·ªçi
    window.updateTeamScore = updateTeamScore;

    // **********************************************
    // 2. LOGIC T·∫¢I V√Ä CH·∫§M C√ÇU H·ªéI
    // **********************************************
    
    function renderMath() {
        if (window.MathJax) {
            MathJax.typesetPromise([questionTextEl, optionsContainerEl]);
        }
    }

    function loadQuestion() {
    if (currentQuestionIndex >= questions.length) {
        endGame();
        return;
    }

    const currentQ = questions[currentQuestionIndex];
    
    // Giao di·ªán
    buzzerMessageEl.textContent = "S·∫µn s√†ng b·∫•m chu√¥ng...";
    nextQuestionButton.style.display = 'none';
    resultMessageEl.textContent = 'Ch·ªù ƒë·ªôi b·∫•m chu√¥ng v√† tr·∫£ l·ªùi...';
    resultMessageEl.style.color = '#333';
    qNumberEl.textContent = currentQuestionIndex + 1;
    
    // Reset v√† C·∫•u h√¨nh n·ªôi dung cho c√°c n√∫t ƒë√°p √°n
    optionElements.forEach((el, index) => {
        el.classList.remove('correct', 'incorrect', 'disabled');
        // KH√îNG X√ìA EL.ONCLICK = NULL N·ªÆA
        el.querySelector('span').innerHTML = currentQ.options[index];
    });
    
    questionTextEl.innerHTML = currentQ.q;
    renderMath();

    // *** ƒêI·ªÇM M·ªöI: K√≠ch ho·∫°t click cho c√°c ph∆∞∆°ng √°n ngay l·∫≠p t·ª©c ***
    // L√∫c n√†y click v√†o s·∫Ω b√°o l·ªói "Vui l√≤ng ƒë·ª£i ƒë·ªôi b·∫•m chu√¥ng..."
    enableAnswerChecking(); 
}

    // H√ÄM M·ªöI: Ch·ªâ b·∫≠t l·∫°i s·ª± ki·ªán click cho c√°c ph∆∞∆°ng √°n ch∆∞a ƒë∆∞·ª£c ch·∫•m (kh√¥ng c√≥ class incorrect/correct)
function enableAnswerChecking() {
    optionElements.forEach((el) => {
        // Ch·ªâ b·∫≠t l·∫°i s·ª± ki·ªán click n·∫øu ƒë√°p √°n ƒë√≥ ch∆∞a b·ªã ƒë√°nh d·∫•u l√† sai (incorrect) ho·∫∑c ƒë√∫ng (correct)
        if (!el.classList.contains('incorrect') && !el.classList.contains('correct')) {
             el.classList.remove('disabled');
             el.onclick = () => checkBuzzedAnswer(el);
        }
    });
}
    
    function disableAnswerChecking() {
         optionElements.forEach((el) => {
            el.classList.add('disabled'); 
            el.onclick = null;
        });
    }

    // H√ÄM M·ªöI: Ch·ªâ ch·∫°y khi c√≥ ƒë·ªôi tr·∫£ l·ªùi ƒê√öNG
function highlightAndDisableAll(correctAnswer, selectedElement) {
    optionElements.forEach(el => {
        el.classList.add('disabled'); 
        el.onclick = null;
        if (el.getAttribute('data-answer') === correctAnswer) {
            el.classList.add('correct'); // ƒê√°nh d·∫•u ƒë√°p √°n ƒë√∫ng
        }
        // N·∫øu l√† ƒë√°p √°n sai ƒë√£ ƒë∆∞·ª£c ch·ªçn, n√≥ ƒë√£ b·ªã ƒë√°nh d·∫•u 'incorrect' t·ª´ tr∆∞·ªõc
    });
    // Hi·ªÉn th·ªã n√∫t chuy·ªÉn c√¢u v√† reset chu√¥ng
    nextQuestionButton.style.display = 'block'; 
}

    // H√ÄM M·ªöI: X·ª≠ l√Ω ch·∫•m ƒëi·ªÉm theo l∆∞·ª£t t√≠ch ch·ªçn c·ªßa GV
function checkBuzzedAnswer(selectedElement) {
    if (!currentAnsweringTeamColor) {
        alert("‚ö†Ô∏è C·∫£nh b√°o: Vui l√≤ng ƒë·ª£i ƒë·ªôi b·∫•m chu√¥ng tr∆∞·ªõc khi ch·∫•m ƒëi·ªÉm!");
        return;
    }
    
    const currentQ = questions[currentQuestionIndex];
    const selectedAnswer = selectedElement.getAttribute('data-answer');
    const correctAnswer = currentQ.correct;
    const teamId = currentAnsweringTeamColor;
    
    if (selectedAnswer === correctAnswer) {
        // **TR·∫¢ L·ªúI ƒê√öNG**
        updateTeamScore(teamId, 10);
        selectedElement.classList.add('correct');
        resultMessageEl.innerHTML = `‚úÖ **CH√çNH X√ÅC!** (+10 ƒëi·ªÉm cho ${TEAM_COLORS_DISPLAY[teamId].name}).`;
        resultMessageEl.style.color = '#2ecc71'; 
        
        // Hi·ªán ƒë√°p √°n ƒë√∫ng v√† chu·∫©n b·ªã chuy·ªÉn c√¢u
        highlightAndDisableAll(correctAnswer, selectedElement);
        
   // GV.html (ƒêo·∫°n code ƒê√É S·ª¨A b√™n trong checkBuzzedAnswer - kh·ªëi else)
    } else {
        // **TR·∫¢ L·ªúI SAI**
        updateTeamScore(teamId, -5);
        selectedElement.classList.add('incorrect');
        selectedElement.classList.add('disabled');
        selectedElement.onclick = null; // V√¥ hi·ªáu h√≥a ƒë√°p √°n sai n√†y
        
        // C·∫ßn reset l·∫°i tr·∫°ng th√°i chu√¥ng ƒë·ªÉ ƒë·ªôi kh√°c c√≥ th·ªÉ b·∫•m ti·∫øp
        resultMessageEl.innerHTML = `‚ùå **CH∆ØA CH√çNH X√ÅC!** (-5 ƒëi·ªÉm cho ${TEAM_COLORS_DISPLAY[teamId].name}). **M·ªùi ƒë·ªôi kh√°c b·∫•m chu√¥ng!**`;
        resultMessageEl.style.color = '#e74c3c'; 
        
        // 1. CH·ªà G·ªåI H√ÄM RESET CHU√îNG NH·∫∏:
        resetBuzzerOnly(); // <-- S·ª¨A T·∫†I ƒê√ÇY
        
        currentAnsweringTeamColor = null; // Reset ƒë·ªôi ƒëang tr·∫£ l·ªùi
        
        // 2. B·∫≠t l·∫°i c∆° ch·∫ø click cho c√°c n√∫t c√≤n l·∫°i (enableAnswerChecking s·∫Ω t·ª± ƒë·ªông b·ªè qua n√∫t 'incorrect')
        enableAnswerChecking(); 
    }
}
    
    function endGame() {
        document.getElementById('game-content').style.display = 'none';
        finalResultsEl.style.display = 'block';
    }


    // **********************************************
    // 3. LOGIC K·∫æT N·ªêI CHU√îNG (FIREBASE)
    // **********************************************

    // H√†m n√†y ƒë∆∞·ª£c g·ªçi trong script.js khi c√≥ ƒë·ªôi b·∫•m chu√¥ng h·ª£p l·ªá ƒë·∫ßu ti√™n
    function handleFirstPress(teamId, color) {
        currentAnsweringTeamColor = color; 
        
        buzzerMessageEl.textContent = `üö® ${TEAM_COLORS_DISPLAY[color].name} ƒë√£ b·∫•m tr∆∞·ªõc! Chu√¥ng ƒë√£ kh√≥a.`;
        buzzerMessageEl.style.color = TEAM_COLORS_DISPLAY[color].code;
        
        resultMessageEl.textContent = 'GV t√≠ch ch·ªçn ƒë√°p √°n m√† HS l·ª±a ch·ªçn.';
        resultMessageEl.style.color = '#f1c40f'; // V√†ng
        
        enableAnswerChecking(); // B·∫≠t t√≠nh nƒÉng ch·∫•m ƒëi·ªÉm b·∫±ng c√°ch click v√†o ƒë√°p √°n
    }

    function resetAndNextQuestion() {
        // 1. Reset tr·∫°ng th√°i b·∫•m chu√¥ng tr√™n Firebase (cho ph√©p v√≤ng m·ªõi)
        window.resetBuzzerSession(); 
        
        // 2. Chuy·ªÉn sang c√¢u h·ªèi ti·∫øp theo
        currentQuestionIndex++;
        currentAnsweringTeamColor = null; // Reset ƒë·ªôi ƒëang tr·∫£ l·ªùi
        loadQuestion(); 
        
        buzzerMessageEl.textContent = `S·∫µn s√†ng b·∫•m chu√¥ng cho C√¢u h·ªèi ${currentQuestionIndex + 1}!`;
    }

  </script>
</body>
</html>